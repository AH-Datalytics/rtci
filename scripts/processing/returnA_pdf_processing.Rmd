---
title: "returnA_pdf_processing"
output: pdf_document
date: "2024-03-06"
---
```{r}
#install.packages("pdftools")
library(pdftools)
library(tidyverse)
library(stringr)
```

pdf(file = "tmp.pdf")
plot(1, main = "mytext")
dev.off()
pdftools::pdf_text(pdf = "tmp.pdf")

```{r}
knox_returnA_jan <- pdf_text("0470100ReturnA01-2024.pdf")
knox_returnA_feb <- pdf_text("0470100ReturnA02-2024.pdf")
knox_returnA_mar <- pdf_text("0470100ReturnA03-2024.pdf")
```
check the column names
```{r}
head(knox_returnA_jan)
head(knox_returnA_feb)
head(knox_returnA_mar)
```

how many elements did this create?
```{r}
length(knox_returnA_jan)
```

```{r}
knox_returnA <- knox_returnA_jan[1]
knox_returnA <- strsplit(knox_returnA, "\n")
knox_returnA <- knox_returnA[[1]]
```

what does this look like?
```{r}
head(knox_returnA)
```
ditch the white space
```{r}
knox_ws <- trimws(knox_returnA)

```
let's get rid of the extra text
```{r}
knox_cleaner <- knox_ws[grep("1. CRIMINAL HOMICIDE", knox_ws):
                                   grep("GRAND TOTAL", knox_ws)]
```
more text to ditch
```{r}
#murder category
knox_cleaner <- sub("a. MURDER AND NONNEGLIGENT HOMICIDE", "",knox_cleaner)
knox_cleaner <-sub("\\(Score attempts as aggravated",  "",knox_cleaner )
knox_cleaner <- sub("assault\\) If homicide reported, submit","", knox_cleaner)
knox_cleaner <-sub("Supplementary Homicide Report", "",knox_cleaner)
knox_cleaner <-sub("b. MANSLAUGHTER BY NEGLIGENCE", "",knox_cleaner)

#rape category 
knox_cleaner <-sub("a. Rape","", knox_cleaner)
knox_cleaner <-sub("b. Attempts to commit Rape", "",knox_cleaner  )
knox_cleaner <-sub("Historic \\(See Instruction \\#15 Below\\)", "",knox_cleaner ) 

#Robbery and Assault have these sub-categories
##GSUB 
knox_cleaner <-gsub("a. Firearm"," ",knox_cleaner)  
knox_cleaner <-gsub("b. Knife or Cutting Instrument","",knox_cleaner) 
knox_cleaner <-gsub("c. Other Dangerous Weapon","",knox_cleaner) 

#back to robbery
knox_cleaner <-sub("d. Strong - Arm \\(Hands, Fists, Feet, Etc\\)","",knox_cleaner)   

#onto assault
knox_cleaner <-sub("d. Hands, Fists, Feet, Etc - Aggravated injury", "", knox_cleaner)
knox_cleaner <-sub("e. Other Assaults - Simple Not Aggravated", "", knox_cleaner)

#burglary
knox_cleaner <-sub("a. Forcible Entry", "", knox_cleaner)
knox_cleaner <-sub("b. Unlawful Entry - No Force", "", knox_cleaner)
knox_cleaner <-sub("c. Attempted Forcible Entry", "", knox_cleaner)

#larceny
knox_cleaner <-sub("(Except Motor Vehicle Theft)", "", knox_cleaner)
knox_cleaner <-sub("a. Autos", "", knox_cleaner)
knox_cleaner <-sub("b. Trucks and Buses", "", knox_cleaner)
knox_cleaner <-sub("c. Other Vehicles", "", knox_cleaner)
knox_cleaner <- sub("\\(\\)","",knox_cleaner)
```
after getting rid of the language, time to paste together elements
```{r}
#homicide parsed funny
hom_elements <- knox_cleaner[5]
hom_elements <- str_squish(hom_elements)
hom_1 <- strsplit(hom_elements,"[[:blank:]]")[[1]][1]
hom_2 <- strsplit(hom_elements,"[[:blank:]]")[[1]][2]

knox_cleaner[1] <- paste(knox_cleaner[1],hom_1,
                         knox_cleaner[4],hom_2, sep = "  ")

knox_cleaner[2] <- paste(knox_cleaner[9],knox_cleaner[10], sep = "  ")

knox_cleaner[3] <- paste(knox_cleaner[19],knox_cleaner[20], sep = "  ")

knox_cleaner[4] <- paste(knox_cleaner[25],knox_cleaner[26], sep = "  ")

#burglary parsed funny
burg_elements <- knox_cleaner[34]
burg_elements <- str_squish(burg_elements)
burg_1 <- strsplit(burg_elements,"[[:blank:]]")[[1]][1]
burg_2 <- strsplit(burg_elements,"[[:blank:]]")[[1]][2]
burg_3<- strsplit(burg_elements,"[[:blank:]]")[[1]][3]
burg_4<- strsplit(burg_elements,"[[:blank:]]")[[1]][4]
burg_5<- strsplit(burg_elements,"[[:blank:]]")[[1]][5]
burg_6<- strsplit(burg_elements,"[[:blank:]]")[[1]][6]
burg_7<- strsplit(burg_elements,"[[:blank:]]")[[1]][7]
burg_8<- strsplit(burg_elements,"[[:blank:]]")[[1]][8]

knox_cleaner[5] <- paste(burg_2, knox_cleaner[33],burg_4, burg_5, burg_6, burg_7, burg_8, sep = "  ")

knox_cleaner[6] <- paste(knox_cleaner[41],knox_cleaner[42], sep = "  ")

knox_cleaner[7] <- paste(knox_cleaner[43],knox_cleaner[44], sep = "  ")
```
check it out
```{r}
knox_cleaner_still <- str_split_fixed(knox_cleaner, " {2,}",7)
knox_cleaner_still
```
fix column white space
```{r}
knox_cleaner_still <- str_split_fixed(knox_cleaner, " {2,}",7)

```
add some column names
```{r}
knox_table <- data.frame(knox_cleaner_still)

names(knox_table) <- c("crime_type",
                                                  "data_entry",
                                                  "reported",
                                                  "unfounded", 
                                                  "actual",
                                                  "cleared",
                                                  "minor")
```
let's see it now
```{r}
knox_table
```
get rid of old rows
```{r}
knox_table_subset <- knox_table[1:7, ]
```
turn the crime type variable into a factor and recode
```{r}
#convert to factor first
knox_table_subset$crime_type <- as.character(knox_table_subset$crime_type)

#try again...
knox_table_subset$crime_type <- recode(knox_table_subset$crime_type, 
                                "1. CRIMINAL HOMICIDE" = "HOMICIDE",
                                "2. RAPE TOTAL" = "RAPE",
                                "3. ROBBERY TOTAL"= "ROBBERY",
                                "4. ASSAULT TOTAL"= "ASSAULT",
                                "BURGLARY" = "BURGLARY",
                                "6. LARCENY - THEFT TOTAL" = "LARCENY",
                                "7. MOTOR VEHICLE THEFT TOTAL" = "MVT"
                                                                                  )
```
write it out!
```{r}
write.csv(knox_table_subset, "knox_returnA_jan24.csv")
```




#notes
#Online version
#pdftools::pdf_text(pdf = "http://arxiv.org/pdf/1403.2805.pdf")
