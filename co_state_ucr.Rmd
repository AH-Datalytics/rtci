---
title: "colorado ucr processing"
output: pdf_document
date: "2024-04-18"
updated: "2024-06-10"
---

```{r}
library(tidyverse)
library(stringr)
```
directory path where the arizona files are stored
```{r}
data_dir <- "C:\\OneDrive\\OneDrive - ahdatalytics.com\\Clients\\Real Time Crime Index\\Open Source Data\\Colorado\\State UCR"
```
read everything in, extract the month/year and do the initial processing
```{r}
# List all CSV files in the directory
file_paths <- list.files(data_dir, pattern = "\\.csv$", full.names = TRUE)

# Debug: Check if any files are listed
if (length(file_paths) == 0) {
  stop("No CSV files found in the specified directory.")
} else {
  message("Processing ", length(file_paths), " files.")
}

# Function to read a CSV and extract date parts
process_csv <- function(file_path) {
  # Debug: Check the file path
  message("Reading file: ", file_path)
  
  # Attempt to read the CSV file
  tryCatch({
    df <- read_csv(file_path, show_col_types = FALSE)
  }, error = function(e) {
    warning("Failed to read: ", file_path, " Error: ", e$message)
    return(NULL)  # Return NULL if the file cannot be read
  })

  # Extract the first 7 characters from the filename (assumes 'YYYY-MM' format)
  filename <- basename(file_path)
  date_part <- substr(filename, 1, 7)

  # Parse year and month from the date_part
  year <- as.integer(substr(date_part, 1, 4))
  month <- as.integer(substr(date_part, 6, 7))

  # Add year and month as columns
  if (!is.na(year) && !is.na(month)) {
    df <- df %>%
      mutate(Year = year, Month = month)
  } else {
    warning("Date parsing failed for: ", filename)
  }

  return(df)
}

# Apply the function to each file path and store dataframes in a list
ldf <- setNames(lapply(file_paths, process_csv), basename(file_paths))

```
check it out
```{r}
head(ldf[1])
```
drop first rows and column row
```{r}
remove_rows_and_columns <- function(df) {
  df <- df[-c(1:6, ncol(df)), ]
  return(df)
}

# Apply the function to each dataframe in the list
ldf1 <- lapply(ldf, remove_rows_and_columns)

# Print first dataframe in list to see
print(ldf1[1])
```
rename columns
```{r}
col_names <- c("Agency Name","Murder", "Rape", "Agg Assault", "Arson",
               "Burglary/Breaking & Entering", "Robbery",
               "Theft From Building", "Theft From Coin Operated Machine Or Device", "Theft From Motor Vehicle", "Theft of Motor Vehicle Parts/Accessories", "All Other Larceny", "Motor Vehicle Theft", "Year", "Month"
)

ldf2 <- lapply(ldf1, setNames, col_names)

```
fill in empty cells with 0
```{r}
#simple function to apply to all dataframes in list
replace_empty_with_zero <- function(df) {
  df[df == ""] <- "0"
  df
}

# Apply the function to each data frame in the list
ldf3 <- lapply(ldf2, replace_empty_with_zero)

#convert these fields to numeric
convert_to_numeric <- function(df) {
  df[, -1] <- lapply(df[, -1], as.numeric)
  return(df)
}

# Apply the function to each dataframe in the list
ldf3_num <- lapply(ldf3, convert_to_numeric)

# Print the modified list of data frames
print(ldf3[1])
```
sum column values to get SRS figures from NIBRS
From NIBRS OFFENSE CODES MANUAL 2011
```{r}
#murder 09A - Murder & Nonnegligent Manslaughter

#rape - 11A - Forcible Rape

#agg assault - 13A - Aggravated Assault

#robbery - 120 - Robbery

#burglary - 220 - Burglary/Breaking & Entering

#Larceny/Theft Offenses to sum
#Pocket-picking Property,  Purse-snatching Property,  Shoplifting Property,  Theft From Building Property,  Theft From Coin-Operated Machine or Device Property,  Theft From Motor Vehicle Property,  Theft of Motor Vehicle Parts or Accessories Property,All Other Larceny Property

# Define the function to sum larceny columns
sum_larceny <- function(df) {
  # List of specific columns related to larceny
  columns_to_larc <- c("Pocket-picking", "Purse-snatching", "Shoplifting", 
                       "Theft From Building", "Theft From Coin Operated Machine or Device", 
                       "Theft From Motor Vehicle", "Theft From Motor Vehicle Parts/Accessories", 
                       "All Other Larceny")
  
  # Identify which columns are actually present in the dataframe
  present_columns <- columns_to_larc[columns_to_larc %in% names(df)]

  # Calculate the sum of the available specified columns and create a new column 'Larceny'
  if (length(present_columns) > 0) {
    df$Larceny <- rowSums(df[present_columns], na.rm = TRUE)
  } else {
    # If no specified columns are present, warn and create Larceny as all NA
    warning("None of the larceny columns are present in the dataframe. Creating 'Larceny' with NA.")
    df$Larceny <- NA
  }
  
  return(df)
}


# Applying the function to each dataframe in the list
ldf4 <- lapply(ldf3_num, sum_larceny)


#mvt - 240 - Motor Vehicle Theft

#arson -200 - Arson

head(ldf4[3])
```
drop unnecessary columns
```{r}
#we need...
columns_to_keep <- c("Agency Name", 
                 "Murder",
                 "Rape", "Robbery", "Agg Assault", 
                 "Burglary/Breaking & Entering",
                 "Larceny", "Motor Vehicle Theft",
                 "Arson", "Year", "Month" )

# Function to keep specified columns from a dataframe
keep_columns <- function(df) {
  df_subset <- subset(df, select = columns_to_keep)
  return(df_subset)
}

# Apply the function to each dataframe in the list
ldf5 <- lapply(ldf4, keep_columns)
```
rename each column for all dataframes in list
```{r}
#list of column names
final_col_names <-  c("Agency Name","Murder",	"Rape",	"Robbery",
"Agg Assault",	"Burglary",	"Larceny",	"MVT",	"Arson", "Year", "Month")

#apply column names
ldf6 <- lapply(ldf5, setNames, final_col_names)

ldf6[1]
```
find and ditch the empty row and everything after it
```{r}
# Function to trim dataframe from the first NA in the "Agency Name" column
trim_agency_na <- function(df) {
  # Check if 'Agency Name' column exists
  if (!"Agency Name" %in% names(df)) {
    stop("The 'Agency Name' column does not exist in the dataframe.")
  }

  # Find the index of the first NA in the 'Agency Name' column
  first_na_index <- which(is.na(df[["Agency Name"]]))[1]

  # Check if there is an NA in 'Agency Name'
  if (!is.na(first_na_index)) {
    # Trim the dataframe to exclude the row with the first NA and all rows after it
    df <- df[1:(first_na_index - 1), ]
  } else {
    message("No NA values detected in the 'Agency Name' column.")
  }

  return(df)
}

# Apply the trim_agency_na function to each dataframe in the list
ldf7 <- lapply(ldf6, trim_agency_na)
```
convert columns to numeric and fill in NA's with 0
```{r}
replace_na <- function(df) {
  # Get the total number of columns in the dataframe
  num_cols <- ncol(df)
  
  # Define the columns where NA should be replaced with 0
  # Skip the first column
  cols_to_replace <- (2:num_cols)
  
  # Use mutate(across()) to replace NAs in specified columns
  df <- df %>%
    mutate(across(cols_to_replace, ~if_else(is.na(.), 0, .)))
  
  return(df)
}

# Applying the function to each dataframe in the list
ldf8 <- lapply(ldf7, replace_na)

head(ldf8[1])
```




row bind the list together
```{r}
combined_df <- do.call(rbind, ldf8)
```
reorder columns and done
```{r}
# Specified order for the columns
column_order <- c("Agency Name", "Murder", "Rape", "Robbery", 
                  "Agg Assault", "Burglary", "Larceny", "MVT", "Arson",
                   "Month", "Year")

# Reorder columns based on the specified order
final_df <- combined_df[, column_order]
```
write it out!
```{r}
# Specify the folder path
folder_path <- "C:\\OneDrive\\OneDrive - ahdatalytics.com\\Clients\\Real Time Crime Index\\Open Source Data\\Colorado\\Formatted Data"

# Create the full file path
file_path <- file.path(folder_path, "co_jan22_present.csv")

# Write the data frame to a .csv file
write.csv(final_df, file = file_path, row.names = FALSE)
```