---
title: "texas ucr processing"
output: pdf_document
date: "2024-04-19"
updated: "2024-05-03"
---
```{r}
library(readxl)
library(tidyverse)
library(stringr)
```
these are monthly files so let's read them all in using a list command
```{r}
folder_path <- "C:\\OneDrive\\OneDrive - ahdatalytics.com\\Clients\\Real Time Crime Index\\Open Source Data\\Texas\\State UCR"

# List all Excel files in the directory
file_list <- list.files(path = folder_path, pattern = "\\.xlsx$", full.names = TRUE)

# Function to process each file
process_file <- function(file_path) {
  # Read the first sheet from the Excel file
  df <- read_excel(file_path, sheet = 1)
  
  # Extract the year-month from the file name
  file_name <- basename(file_path)
  year_month <- sub("_.*", "", file_name)  # Remove everything after the underscore
  
  # Extract year and month separately
  year <- substr(year_month, 1, 4)
  month <- substr(year_month, 6, 7)
  
  # Create new columns for year and month
  df$Year <- as.integer(year)
  df$Month <- as.integer(month)
  
  # Optionally, set names or other metadata
  df_name <- paste("data", year, month, sep = "_")
  assign(df_name, df, envir = .GlobalEnv)
  
  return(df)
}

# Apply the function to each file and store the results in a list
dataframes <- as.list(lapply(file_list, process_file))
```
what does the top look like
```{r}
head(dataframes[1])
```
drop first rows and column row
```{r}
remove_rows_and_columns <- function(df) {
  df <- df[-c(1:4, ncol(df)), ]
  return(df)
}

# Apply the function to each dataframe in the list
list_of_dataframes_trimmed <- lapply(dataframes, remove_rows_and_columns)

# Print first dataframe in list to see
print(list_of_dataframes_trimmed[1])
#make a new vector
ldf1 <- list_of_dataframes_trimmed
```
rename columns
#ORI Number	AgencyName	Murder	Rape	Robbery	Assault	Burglary	Larceny	Auto Theft	Arson	Human Trafficking	Total	Population	Months
```{r}
#list of column names
col_names <- c("ORI Number", "Agency Name", 
              "Murder",	
              "Rape",	
              "Robbery",	
              "Agg Assault",	
              "Burglary",	
              "Larceny",	
              "MVT",	
              "Arson",
              "Human Trafficking",
              "Total",
              "Population",
              "Months",
              "Year",
              "Month"
              )

#apply the function
ldf2 <- lapply(ldf1, setNames, col_names)
ldf2[1]
```
remove unnecessary columns
```{r}
columns_to_remove <- c("ORI Number", "Human Trafficking",
              "Total",
              "Population",
              "Months")

# Function to remove columns from a data frame and apply to each dataframe in a list
remove_columns_and_apply <- function(df_list, column_names) {
  modified_dataframes <- lapply(df_list, function(df) df[, !names(df) %in% column_names, drop = FALSE])
  return(modified_dataframes)
}

# Apply the function to the list of data frames
modified_dataframes <- remove_columns_and_apply(ldf2, columns_to_remove)
```
row bind the list together
```{r}
combined_df <- do.call(rbind, modified_dataframes)

```
agency = character; count fields = numeric; month/ year = numeric 1-12; 2022-2024
```{r}
# Directly specify conversions without altering first column initially
df <- combined_df %>%
  mutate(`Agency Name` = as.character(`Agency Name`), # Ensure first column remains character
         across(-`Agency Name`, as.numeric)) # Convert all other columns to numeric

# Check the structure of the dataframe to confirm types
str(df)
```

add a column for State and then we're done.
```{r}
# Specify the value for the "State" column
state_value <- "Texas"

# Add the "State" column to the data frame
final_df$State <- state_value
```
write it out- still needs to be transformed
```{r}
# Specify the folder path
folder_path <- "C:\\OneDrive\\OneDrive - ahdatalytics.com\\Clients\\Real Time Crime Index\\Open Source Data\\Texas\\Formatted Data"

# Create the full file path
file_path <- file.path(folder_path, "tx_jan22_present.csv")

# Write the data frame to a .csv file
write.csv(final_df, file = file_path, row.names = FALSE)
```

