---
title: "nevada ucr processing"
output: pdf_document
date: "2024-04-19"
updated: "2024-06-10"
updated: "2024-06-28"
---
```{r}
library(tidyverse)
library(stringr)
```
directory location
```{r}
data_dir <- "C:\\OneDrive\\OneDrive - ahdatalytics.com\\Clients\\Real Time Crime Index\\Open Source Data\\Nevada\\State UCR"
```
read everything in, extract the month/year and do the initial processing
```{r}
# List all CSV files in the directory
file_paths <- list.files(data_dir, pattern = "\\.csv$", full.names = TRUE)

# Debug: Check if any files are listed
if (length(file_paths) == 0) {
  stop("No CSV files found in the specified directory.")
} else {
  message("Processing ", length(file_paths), " files.")
}

# Function to read a CSV and extract date parts
process_csv <- function(file_path) {
  # Debug: Check the file path
  message("Reading file: ", file_path)
  
  # Attempt to read the CSV file
  tryCatch({
    df <- read_csv(file_path, show_col_types = FALSE)
  }, error = function(e) {
    warning("Failed to read: ", file_path, " Error: ", e$message)
    return(NULL)  # Return NULL if the file cannot be read
  })

  # Extract the first 7 characters from the filename (assumes 'YYYY-MM' format)
  filename <- basename(file_path)
  date_part <- substr(filename, 1, 7)

  # Parse year and month from the date_part
  year <- as.integer(substr(date_part, 1, 4))
  month <- as.integer(substr(date_part, 6, 7))

  # Add year and month as columns
  if (!is.na(year) && !is.na(month)) {
    df <- df %>%
      mutate(Year = year, Month = month)
  } else {
    warning("Date parsing failed for: ", filename)
  }

  return(df)
}

# Apply the function to each file path and store dataframes in a list
ldf <- setNames(lapply(file_paths, process_csv), basename(file_paths))
```
what does the top look like
```{r}
head(ldf[1])
```






drop first rows and column row
```{r}
remove_rows_and_columns <- function(df) {
  df <- df[-c(1:6, ncol(df)), ]
  return(df)
}

# Apply the function to each dataframe in the list
list_of_dataframes_trimmed <- lapply(list_rename, remove_rows_and_columns)

# Print first dataframe in list to see
print(list_of_dataframes_trimmed[1])
#make a new vector
ldf1 <- list_of_dataframes_trimmed
```

rename columns
#Murder and Nonnegligent Homicide	Forcible Rape	Robbery	Aggravated Assault	Burglary	Larceny - Theft	Motor Vehicle Theft	Arson
```{r}
col_names <- c("Agency Name", 
              "Murder and Nonnegligent Homicide",	
              "Forcible Rape",	
              "Robbery",	
              "Aggravated Assault",	
              "Burglary",	
              "Larceny - Theft",	
              "Motor Vehicle Theft",	
              "Arson"

)

ldf2 <- lapply(ldf1, setNames, col_names)

```
fill in empty cells with 0
```{r}
#simple function to apply to all dataframes in list
replace_empty_with_zero <- function(df) {
  df[df == ""] <- "0"
  df
}

# Apply the function to each data frame in the list
ldf3 <- lapply(ldf2, replace_empty_with_zero)

#convert these fields to numeric
convert_to_numeric <- function(df) {
  df[, -1] <- lapply(df[, -1], as.numeric)
  return(df)
}

# Apply the function to each dataframe in the list
ldf3_num <- lapply(ldf3, convert_to_numeric)

# Print the modified list of data frames
print(ldf3[1])

```


rename each column for all dataframes in list
```{r}
#list of column names
final_col_names <-  c("Agency Name","Murder",	"Rape",	"Robbery",
"Agg Assault",	"Burglary",	"Larceny",	"MVT",	"Arson")

#apply column names
ldf4 <- lapply(ldf3, setNames, final_col_names)

ldf4[1]
```
add a column the designates the time period
```{r}
list_of_dataframes <- ldf4

# Function to add a column with the name of the data frame
add_column_with_dataframe_name <- function(df) {
  df$name_column <- names(list_of_dataframes)[match(deparse(substitute(df)), names(list_of_dataframes))]
  df
}

# Apply the function to each data frame in the list
list_of_dataframes_with_column <- lapply(names(list_of_dataframes), function(df_name) {
  df <- list_of_dataframes[[df_name]]
  df$name_column <- df_name
  df
})
ldf5 <- list_of_dataframes_with_column
```
row bind the list together
```{r}
combined_df <- do.call(rbind, list_of_dataframes_with_column)

```
write it out- still needs to be transformed
```{r}
write.csv(combined_df, "nv_state_ucr_all.csv")


```
we need to get rid of agencies that are not cities/part of our list
```{r}

```




#notes
#Online version
#pdftools::pdf_text(pdf = "http://arxiv.org/pdf/1403.2805.pdf")
