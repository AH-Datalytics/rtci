---
title: "missouri ucr processing"
output: pdf_document
date: "2024-04-19"
updated: "2024-06-10"
---
load libraries
```{r}
library(tidyverse)
library(stringr)
```
directory location
```{r}
data_dir <- "C:\\OneDrive\\OneDrive - ahdatalytics.com\\Clients\\Real Time Crime Index\\Open Source Data\\Missouri\\State UCR"
```
read everything in, extract the month/year and do the initial processing
```{r}
# List all CSV files in the directory
file_paths <- list.files(data_dir, pattern = "\\.csv$", full.names = TRUE)

# Debug: Check if any files are listed
if (length(file_paths) == 0) {
  stop("No CSV files found in the specified directory.")
} else {
  message("Processing ", length(file_paths), " files.")
}

# Function to read a CSV and extract date parts
process_csv <- function(file_path) {
  # Debug: Check the file path
  message("Reading file: ", file_path)
  
  # Attempt to read the CSV file
  tryCatch({
    df <- read_csv(file_path, show_col_types = FALSE)
  }, error = function(e) {
    warning("Failed to read: ", file_path, " Error: ", e$message)
    return(NULL)  # Return NULL if the file cannot be read
  })

  # Extract the first 7 characters from the filename (assumes 'YYYY-MM' format)
  filename <- basename(file_path)
  date_part <- substr(filename, 1, 7)

  # Parse year and month from the date_part
  year <- as.integer(substr(date_part, 1, 4))
  month <- as.integer(substr(date_part, 6, 7))

  # Add year and month as columns
  if (!is.na(year) && !is.na(month)) {
    df <- df %>%
      mutate(Year = year, Month = month)
  } else {
    warning("Date parsing failed for: ", filename)
  }

  return(df)
}

# Apply the function to each file path and store dataframes in a list
ldf <- setNames(lapply(file_paths, process_csv), basename(file_paths))
```
what does the top look like
```{r}
head(ldf[1])
```
drop first rows and column row
```{r}
remove_rows <- function(df) {
  df <- df[-c(1:6, ncol(df)), ]
  return(df)
}

# Apply the function to each dataframe in the list
ldf1 <- lapply(ldf, remove_rows)

# Print first dataframe in list to see
print(ldf1[1])
```
rename columns
```{r}
col_names <- c("Agency Name", 
              "Murder and Nonnegligent Homicide",	
              "Forcible Rape",	
              "Robbery",	
              "Aggravated Assault",	
              "Burglary",	
              "Larceny - Theft",	
              "Motor Vehicle Theft",	
              "Arson",
              "Year",
              "Month"

)

ldf2 <- lapply(ldf1, setNames, col_names)
```
take a look
```{r}
print(ldf2[1])
```

convert columns to numeric, replace NA's with 0's
```{r}
convert_and_replace <- function(df) {
  # Process each column except the first
  for (i in 2:ncol(df)) {
    # Convert the column to numeric
    df[[i]] <- as.numeric(df[[i]])
    # Replace NAs with 0
    df[[i]][is.na(df[[i]])] <- 0
  }
  return(df)
}

ldf3 <- lapply(ldf2, convert_and_replace)

head(ldf3[1])
```

drop unnecessary columns
```{r}
columns_to_keep <- c("Agency Name", 
               "Murder and Nonnegligent Homicide", "Forcible Rape", 
               "Robbery", 
               "Aggravated Assault", 
               "Burglary", 
               "Larceny - Theft", 
               "Motor Vehicle Theft", "Arson",
               "Year", "Month")

# Function to keep specified columns from a dataframe
keep_columns <- function(df) {
  df_subset <- subset(df, select = columns_to_keep)
  return(df_subset)
}

# Apply the function to each dataframe in the list
ldf4 <- lapply(ldf3, keep_columns)

ldf4[1]
```


rename each column for all dataframes in list
```{r}
#list of column names
final_col_names <-  c("Agency Name","Murder",	"Rape",	"Robbery",
"Agg Assault",	"Burglary",	"Larceny",	"MVT",	"Arson", "Year", "Month")

#apply column names
ldf5 <- lapply(ldf4, setNames, final_col_names)

ldf5[1]
```

row bind the list together
```{r}
combined_df <- do.call(rbind, ldf5)
```
reorder columns and done
```{r}
# Specified order for the columns
column_order <- c("Agency Name", "Murder", "Rape", "Robbery", 
                  "Agg Assault", "Burglary", "Larceny", "MVT", "Arson",
                   "Month", "Year")

# Reorder columns based on the specified order
final_df <- combined_df[, column_order]
```
write it out!
```{r}
# Specify the folder path
folder_path <- "C:\\OneDrive\\OneDrive - ahdatalytics.com\\Clients\\Real Time Crime Index\\Open Source Data\\Missouri\\Formatted Data"

# Create the full file path
file_path <- file.path(folder_path, "mo_jan22_present.csv")

# Write the data frame to a .csv file
write.csv(final_df, file = file_path, row.names = FALSE)
```



