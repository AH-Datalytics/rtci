---
title: "rtci_viz_dev"
author: "dave"
date: "2024-06-11"
output: html_document
---
This works.
```{r}
library(shiny)
library(ggplot2)
library(dplyr)
library(shinyWidgets)
library(plotly)
library(lubridate)
library(tidyverse)

# Assuming the data loading and transformation code remains the same
data <- read_csv("../data/final_data.csv")
data$Date <- as.Date(paste0(data$year,"-",data$Month, "-01"), format = "%Y-%m-%d")


# Minimum and maximum months for the slider
min_month <- min(data$Month)
max_month <- max(data$Month)

# Shiny UI
ui <- fluidPage(
  titlePanel("Real-Time Crime Index"),

  sidebarLayout(
    sidebarPanel(
      selectInput("agencyName", "Select Agency:", choices = unique(data$`Agency Name`)),
      selectInput("crimeType", "Select Crime Type:", choices = unique(data$`Crime Type`))
    ),
    
    mainPanel(
      # Date range slider at the top of the main panel
      sliderInput("dateRange", "Select Date Range:",
                  min = min_month, max = max_month,
                  value = c(min_month, max_month),
                  timeFormat = "%Y-%m",
                  step = 1,  # Approximately one month in seconds
                  sep = ""),
      
      plotlyOutput("crimePlot"),
      downloadButton("downloadData", "Download Data"),
      downloadButton("downloadPlot", "Download Plot")
    )
  )
)

# Shiny Server
server <- function(input, output) {
  
  # Filtered data based on UI inputs
  filteredData <- reactive({
    req(input$dateRange)  # Ensure the date range is selected
    data %>%
      filter(`Crime Type` %in% input$crimeType,
             `Agency Name` %in% input$agencyName,
             Month >= as.Date(input$dateRange[1]),
             Month <= as.Date(input$dateRange[2]))
  })
  
  # Generate plot
  output$crimePlot <- renderPlotly({
    req(filteredData())  # Ensure data is available
    gg <- ggplot(filteredData(), aes(x = Month, y = Total_Incidents, group = `Crime Type`)) +
      geom_line(aes(color = `Crime Type`), size = 1) +
      geom_point(aes(color = `Crime Type`)) +
      labs(title = "Crime Count Over Time", x = "Month", y = "Count of Crimes") +
      theme_minimal()
    ggplotly(gg) %>% layout(hovermode = "closest")
  })
  
  # Download handlers
  output$downloadData <- downloadHandler(
    filename = function() {
      paste("Crime-Data-", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(filteredData(), file)
    }
  )
  
  output$downloadPlot <- downloadHandler(
    filename = function() {
      paste("Crime-Plot-", Sys.Date(), ".jpeg", sep = "")
    },
    content = function(file) {
      ggsave(file, plot = ggplot2::last_plot(), device = "jpeg")
    }
  )
}

# Run the application
shinyApp(ui = ui, server = server)


```
this is the test version that i will reconcile with the base. this is a promising base too.
```{r}
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(lubridate)
library(DT)  # For datatable rendering

# Assuming data is already loaded and transformed
data <- final_data  # Ensure 'final_data' is properly loaded with appropriate columns
data$Date <- as.Date(paste0(data$Year, "-", data$Month, "-01"), format = "%Y-%m-%d")
data$Month <- floor_date(data$Date, "month")

# Shiny UI
ui <- fluidPage(
  titlePanel("Real-Time Crime Index"),
  sidebarLayout(
    sidebarPanel(
      selectInput("agencyName", "Select Agency:", choices = unique(data$`Agency Name`)),
      selectInput("crimeType", "Select Crime Type:", choices = unique(data$`Crime Type`)),
      downloadButton("downloadData", "Download Data")
    ),
    mainPanel(
      plotlyOutput("crimePlot"),
      DTOutput("dataTable"),
      div(style = "text-align: right;", downloadButton("downloadPlot", "Download Plot"))
    )
  )
)

# Shiny Server
server <- function(input, output) {
  # Reactive data based on user inputs
  filteredData <- reactive({
    data %>%
      filter(`Crime Type` %in% input$crimeType,
             `Agency Name` %in% input$agencyName) %>%
      arrange(Month)  # Ensure data is sorted by date
  })

  # Generate plot
  output$crimePlot <- renderPlotly({
    df <- filteredData()  # Get the reactive data
    plot_ly(df, x = ~Month, y = ~Total_Incidents, color = ~`Crime Type`, type = 'scatter', mode = 'lines+markers') %>%
      layout(
        xaxis = list(title = "", tickformat = "%b %Y"),
        yaxis = list(title = "Count of Crimes"),
        margin = list(l = 60, r = 60, t = 20, b = 50)  # Adjust margins to make space for title
      )
  })

  # Render the data table
  output$dataTable <- renderDT({
    df <- filteredData()  # Get the reactive data
    datatable(df, options = list(pageLength = 10, scrollX = TRUE))  # Enable horizontal scrolling
  })

  # Download handlers
  output$downloadData <- downloadHandler(
    filename = function() {
      paste("Crime-Data-", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(filteredData(), file)
    }
  )

  output$downloadPlot <- downloadHandler(
    filename = function() {
      paste("Crime-Plot-", Sys.Date(), ".jpeg", sep = "")
    },
    content = function(file) {
      plotly_save(plotly_last(), file)
    }
  )
}

# Run the application
shinyApp(ui = ui, server = server)

```
experimental phase - BUTTONS
```{r}
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(lubridate)
library(DT)  # For datatable rendering

# Assuming data is already loaded and transformed
data <- final_data  # Ensure 'final_data' is properly loaded with appropriate columns
data$Date <- as.Date(paste0(data$Year, "-", data$Month, "-01"), format = "%Y-%m-%d")
data$Month <- floor_date(data$Date, "month")

# Shiny UI
ui <- fluidPage(
  titlePanel("Real-Time Crime Index"),
  sidebarLayout(
    sidebarPanel(
      selectInput("agencyName", "Select Agency:", choices = unique(data$`Agency Name`)),
      selectInput("crimeType", "Select Crime Type:", choices = unique(data$`Crime Type`)),
      downloadButton("downloadData", "Download Data")
    ),
    mainPanel(
      div(style = "text-align: right; padding-bottom: 5px;", 
          downloadButton("downloadPlot", "Download Plot")),
      plotlyOutput("crimePlot"),
      DTOutput("dataTable")
    )
  )
)

# Shiny Server
server <- function(input, output) {
  # Reactive data based on user inputs
  reactiveData <- reactive({
    data %>%
      filter(`Crime Type` %in% input$crimeType,
             `Agency Name` %in% input$agencyName) %>%
      arrange(Month)  # Ensure data is sorted by date
  })

  # Generate plot with a time range slider
  output$crimePlot <- renderPlotly({
    df <- reactiveData()  # Get the reactive data
    p <- plot_ly(df, x = ~Month, y = ~Total_Incidents, color = ~`Crime Type`, type = 'scatter', mode = 'lines+markers') %>%
      layout(
        xaxis = list(title = "", tickformat = "%b %Y", rangeselector = list(
          buttons = list(
            list(count = 6, label = "6m", step = "month", stepmode = "backward"),
            list(count = 1, label = "1y", step = "year", stepmode = "backward"),
            list(count = 2, label = "2y", step = "year", stepmode = "backward"),
            list(step = "all")
          ),
          rangeslider = list(visible = TRUE, thickness = 0.1)  # Visible range slider
        )),
        yaxis = list(title = "Count of Crimes")
      )
    return(p)
  })

  # Render the data table
  output$dataTable <- renderDT({
    df <- reactiveData()  # Get the reactive data
    datatable(df, options = list(pageLength = 10, scrollX = TRUE))  # Enable horizontal scrolling
  })

  # Download handlers
  output$downloadData <- downloadHandler(
    filename = function() {
      paste("Crime-Data-", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(reactiveData(), file)
    }
  )

  output$downloadPlot <- downloadHandler(
    filename = function() {
      paste("Crime-Plot-", Sys.Date(), ".jpeg", sep = "")
    },
    content = function(file) {
      plotly_save(plotly_last(), file)
    }
  )
}

# Run the application
shinyApp(ui = ui, server = server)

```
experimental - COLORS
```{r}
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(lubridate)
library(DT)  # For rendering interactive data tables

# Assuming data is already loaded and transformed
data <- final_data
data$Date <- as.Date(paste0(data$Year, "-", data$Month, "-01"), format = "%Y-%m-%d")
data$Month <- floor_date(data$Date, "month")

# Convert dates to numeric for slider input
data$MonthNumeric <- as.numeric(data$Month)

# Shiny UI
ui <- fluidPage(
  tags$head(
    tags$style(HTML("
      body { 
        font-family: 'Roboto Condensed', sans-serif;
        background-color: #00333a;
        color: #ffffff;  # Ensure text is readable against a dark background
      }
      .shiny-output-error { color: #ffffff; }  # Error message color
      .shiny-output-error:before { content: 'Error: '; }
      .sidebar { background-color: #2d5ef9; }  # Change sidebar background color
    "))
  ),
  titlePanel("Real-Time Crime Index", windowTitle = "Crime Data Visualization"),
  sidebarLayout(
    sidebarPanel(
      div(style = "margin-top: 25%; color: #f28106;",  # Adjustments for sidebar text color
          selectInput("agencyName", "Select Agency:", choices = unique(data$`Agency Name`)),
          selectInput("crimeType", "Select Crime Type:", choices = unique(data$`Crime Type`)),
          downloadButton("downloadData", "Download Data")
      )
    ),
    mainPanel(
      div(style = "width: 75%; margin-left: auto; margin-right: auto; padding-top: 20px;",
          sliderInput("timePeriod", "Select Time Period:",
                      min = min(data$MonthNumeric), max = max(data$MonthNumeric),
                      value = range(data$MonthNumeric), 
                      step = 2628000,  # Approximately one month in seconds
                      sep = "", timeFormat = "%b %Y")
      ),
      plotlyOutput("crimePlot"),
      DTOutput("dataTable"),
      div(style = "text-align: right;", downloadButton("downloadPlot", "Download Plot"))
    )
  )
)


# Shiny Server
server <- function(input, output) {
  # Reactive data based on user inputs and slider
  reactiveData <- reactive({
    data %>%
      filter(`Crime Type` %in% input$crimeType,
             `Agency Name` %in% input$agencyName,
             MonthNumeric >= input$timePeriod[1],
             MonthNumeric <= input$timePeriod[2]) %>%
      arrange(Month)
  })

  # Generate plot
  output$crimePlot <- renderPlotly({
    df <- reactiveData()
    plot_ly(df, x = ~Month, y = ~Total_Incidents, color = ~`Crime Type`, type = 'scatter', mode = 'lines+markers',
            line = list(color = "#f28106")) %>%
      layout(
        xaxis = list(tickformat = "%b %Y"),
        yaxis = list(title = "Count of Crimes")
      )
  })

  # Render the data table with updated styles
output$dataTable <- renderDT({
  datatable(reactiveData(), options = list(
    pageLength = 10,
    scrollX = TRUE,
    initComplete = JS("function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#2d5ef9', 'color': '#ffffff'});",
                      "$('.dataTables_wrapper').find('label').each(function() {",
                      "$(this).css('color', '#ffffff');",
                      "});",
                      "$('.dataTables_wrapper').find('.dataTables_info').css('color', '#ffffff');",
                      "$('.dataTables_wrapper').find('.paginate_button').css('color', '#ffffff');",  # Styles all pagination buttons
                      "$('.dataTables_wrapper').find('table').css('color', '#ffffff');",
                      "$('.paginate_button').not('.current').hover(function() {",
                      "$(this).css('color', '#2d5ef9').css('background-color', '#ffffff');",  # Changes button color on hover
                      "}, function() {",
                      "$(this).css('color', '#ffffff').css('background-color', '');",  # Revert on mouse out
                      "});",
                      "}"),
    dom = 'Bfrtip',
    buttons = list(
      'copy', 'csv', 'excel', 'pdf', 'print'
    )
  ), callback = JS("table.draw();"))
})


  # Download handlers
  output$downloadData <- downloadHandler(
    filename = function() {
      paste("Crime-Data-", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(reactiveData(), file)
    }
  )

  output$downloadPlot <- downloadHandler(
    filename = function() {
      paste("Crime-Plot-", Sys.Date(), ".jpeg", sep = "")
    },
    content = function(file) {
      plotly_save(plotly_last(), file)
    }
  )
}

# Run the application
shinyApp(ui = ui, server = server)

```

KPI boxes using colors as a base
```{r}
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(lubridate)
library(DT)  # For rendering interactive data tables

# Assuming data is already loaded and transformed
data <- final_data
data$Date <- as.Date(paste0(data$Year, "-", data$Month, "-01"), format = "%Y-%m-%d")
data$Month <- floor_date(data$Date, "month")
data$Year <- year(data$Date)

# Convert dates to numeric for slider input
data$MonthNumeric <- as.numeric(data$Month)

# Shiny UI
ui <- fluidPage(
  tags$head(
    tags$style(HTML("
      body { 
        font-family: 'Roboto Condensed', sans-serif;
        background-color: #00333a;
        color: #ffffff;  # Ensure text is readable against a dark background
      }
      .shiny-output-error { color: #ffffff; }  # Error message color
      .shiny-output-error:before { content: 'Error: '; }
      .sidebar { background-color: #2d5ef9; }  # Change sidebar background color
    "))
  ),
  titlePanel("Real-Time Crime Index", windowTitle = "Crime Data Visualization"),
  sidebarLayout(
    sidebarPanel(
      div(style = "margin-top: 25%; color: #f28106;",  # Adjustments for sidebar text color
          selectInput("agencyName", "Select Agency:", choices = unique(data$`Agency Name`)),
          selectInput("crimeType", "Select Crime Type:", choices = unique(data$`Crime Type`)),
          downloadButton("downloadData", "Download Data"),
          uiOutput("infoBoxes")  # UI for YTD comparisons
      )
    ),
    mainPanel(
      div(style = "width: 75%; margin-left: auto; margin-right: auto; padding-top: 20px;",
          sliderInput("timePeriod", "Select Time Period:",
                      min = min(data$MonthNumeric), max = max(data$MonthNumeric),
                      value = range(data$MonthNumeric), 
                      step = 2628000,  # Approximately one month in seconds
                      sep = "", timeFormat = "%b %Y")
      ),
      plotlyOutput("crimePlot"),
      DTOutput("dataTable"),
      div(style = "text-align: right;", downloadButton("downloadPlot", "Download Plot"))
    )
  )
)

# Shiny Server
server <- function(input, output) {
  # Reactive data based on user inputs and slider
  reactiveData <- reactive({
    data %>%
      filter(`Crime Type` %in% input$crimeType,
             `Agency Name` %in% input$agencyName,
             MonthNumeric >= input$timePeriod[1],
             MonthNumeric <= input$timePeriod[2]) %>%
      arrange(Month)
  })

  # Calculate and display YTD crime data
  output$infoBoxes <- renderUI({
    df <- reactiveData()
    currentYTD <- df %>%
      filter(Year == max(Year)) %>%
      summarize(YTD = sum(Total_Incidents))
    previousYTD <- df %>%
      filter(Year == max(Year) - 1) %>%
      summarize(YTD = sum(Total_Incidents))
    
    tagList(
      wellPanel(
        style = "background-color: #004953; color: #ffffff;",
        h4("Current Year-to-Date"),
        h5(paste("Total Incidents: ", currentYTD$YTD))
      ),
      wellPanel(
        style = "background-color: #004953; color: #ffffff;",
        h4("Previous Year-to-Date"),
        h5(paste("Total Incidents: ", previousYTD$YTD))
      )
    )
  })

  # Generate plot
  output$crimePlot <- renderPlotly({
    df <- reactiveData()
    plot_ly(df, x = ~Month, y = ~Total_Incidents, color = ~`Crime Type`, type = 'scatter', mode = 'lines+markers',
            line = list(color = "#f28106")) %>%
      layout(
        xaxis = list(tickformat = "%b %Y"),
        yaxis = list(title = "Count of Crimes")
      )
  })

  # Render the data table with updated styles
  output$dataTable <- renderDT({
    datatable(reactiveData(), options = list(
      pageLength = 10,
      scrollX = TRUE,
      initComplete = JS("function(settings, json) {",
                        "$(this.api().table().header()).css({'background-color': '#2d5ef9', 'color': '#ffffff'});",
                        "$('.dataTables_wrapper').find('label').each(function() {",
                        "$(this).css('color', '#ffffff');",
                        "});",
                        "$('.dataTables_wrapper').find('.dataTables_info').css('color', '#ffffff');",
                        "$('.dataTables_wrapper').find('.paginate_button').css('color', '#ffffff');",  # Styles all pagination buttons
                        "$('.paginate_button').not('.current').hover(function() {",
                        "$(this).css('color', '#2d5ef9').css('background-color', '#ffffff');",  # Changes button color on hover
                        "}, function() {",
                        "$(this).css('color', '#ffffff').css('background-color', '');",  # Revert on mouse out
                        "});",
                        "}"),
      dom = 'Bfrtip',
      buttons = list(
        'copy', 'csv', 'excel', 'pdf', 'print'
      )
    ), callback = JS("table.draw();"))
  })

  # Download handlers
  output$downloadData <- downloadHandler(
    filename = function() {
      paste("Crime-Data-", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(reactiveData(), file)
    }
  )

  output$downloadPlot <- downloadHandler(
    filename = function() {
      paste("Crime-Plot-", Sys.Date(), ".jpeg", sep = "")
    },
    content = function(file) {
      plotly_save(plotly_last(), file)
    }
  )
}

# Run the application
shinyApp(ui = ui, server = server)

```
experimental - top secret
```{r}
library(shiny)
library(plotly)
library(dplyr)
library(lubridate)

# Assuming data is already loaded and transformed
data <- final_data
data$Date <- as.Date(paste0(data$Year, "-", data$Month, "-01"), format = "%Y-%m-%d")
data$Month <- floor_date(data$Date, "month")

# Shiny UI
ui <- fluidPage(
  titlePanel("Real-Time Crime Index", windowTitle = "Crime Data Visualization"),
  sidebarLayout(
    sidebarPanel(
      selectInput("agencyName", "Select Agency:", choices = unique(data$`Agency Name`)),
      selectInput("crimeType", "Select Crime Type:", choices = unique(data$`Crime Type`)),
      downloadButton("downloadData", "Download Data")
    ),
    mainPanel(
      # Simulated placement of the range slider control above the plot by arranging UI components
      uiOutput("rangeSliderUI"),
      plotlyOutput("crimePlot")
    )
  )
)

# Shiny Server
server <- function(input, output) {
  # Dynamically generate range slider UI based on the data
  output$rangeSliderUI <- renderUI({
    sliderInput("timePeriod", "Select Time Period:",
                min = min(data$Month), max = max(data$Month),
                value = range(data$Month),
                timeFormat = "%b %Y", step = 1,  # Approximately one month in seconds
                width = '100%')
  })

  # Generate plot with trend lines
  output$crimePlot <- renderPlotly({
    # Filter data based on user input from sidebar
    df <- data %>%
      filter(`Crime Type` %in% input$crimeType,
             `Agency Name` %in% input$agencyName,
             Month >= input$timePeriod[1],
             Month <= input$timePeriod[2])

    # Create a Plotly plot with trend lines
    p <- plot_ly(df, x = ~Month, y = ~Total_Incidents, color = ~`Crime Type`, type = 'scatter', mode = 'lines') %>%
      add_lines() %>%
      layout(
        title = "Crime Trends Over Time",
        xaxis = list(title = "", tickformat = "%b %Y"),
        yaxis = list(title = "Total Incidents")
      )
    return(p)
  })

  # Download handlers
  output$downloadData <- downloadHandler(
    filename = function() {
      paste("Crime-Data-", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(df, file, row.names = FALSE)
    }
  )
}

# Run the application
shinyApp(ui = ui, server = server)


```

next iteration as of 6.20.24
```{r}
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(lubridate)
library(DT)  # For rendering interactive data tables

# Assuming data is already loaded and transformed
data <- final_data
data$Date <- as.Date(paste0(data$Year, "-", data$Month, "-01"), format = "%Y-%m-%d")
data$Month <- floor_date(data$Date, "month")

# Default selections
default_crime_type <- "Aggravated Assault"
default_agency <- sort(unique(data$`Agency Name`))[1]
default_year <- max(data$Year)

# Shiny UI
ui <- fluidPage(
  tags$head(
    tags$style(HTML("
      @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');
      body { 
        font-family: 'Roboto Condensed', sans-serif;
        background-color: #00333a;
        color: #ffffff;  # Ensure text is readable against a dark background
      }
      .shiny-output-error { color: #ffffff; }  # Error message color
      .shiny-output-error:before { content: 'Error: '; }
      .sidebar { background-color: #2d5ef9; }  # Change sidebar background color
      .main-panel { width: 100%; }
      .well { padding: 10px; }  # Reduce the padding in wellPanel for KPI boxes
      h2.title { text-align: center; font-size: 30px; font-family: 'Roboto Condensed', sans-serif; }
    "))
  ),
  div(style = "width: 100%; text-align: center; margin-top: 20px;",  # Center the title within the container
    h2(class = "title", "Real-Time Crime Index")
  ),
  div(style = "width: 100%;",  # Ensure the top panel matches the plot width
    fluidRow(
      column(12, div(style = "padding-top: 20px; font-size: 20px;",
        span("I want to see "),
        div(style = "display: inline-block; width: 20%; position: relative;", 
             selectInput("crimeType", "", choices = unique(data$`Crime Type`), multiple = TRUE, selected = default_crime_type, width = '100%'),
             div(style = "border-bottom: 1px solid #ffffff; width: 100%;")
        ),
        span(" for "),
        div(style = "display: inline-block; width: 20%; position: relative;", 
             selectInput("agencyName", "", choices = unique(data$`Agency Name`), selected = default_agency, width = '100%'),
             div(style = "border-bottom: 1px solid #ffffff; width: 100%;")
        ),
        span(" from "),
        div(style = "display: inline-block; width: 20%; position: relative;", 
             selectInput("yearFilter", "", choices = unique(data$Year), multiple = TRUE, selected = default_year, width = '100%'),
             div(style = "border-bottom: 1px solid #ffffff; width: 100%;")
        )
      ))
    ),
    fluidRow(
      column(12, div(style = "padding-top: 10px; text-align: left;",
        actionButton("toggleView", "Toggle View", class = "btn-primary")
      ))
    )
  ),
  mainPanel(
    class = "main-panel",
    uiOutput("viewOutput"),
    fluidRow(
      column(6,
             wellPanel(
               style = "background-color: #004953; color: #ffffff;",
               h4("Current Year-to-Date"),
               h5(textOutput("currentYTD"))
             )
      ),
      column(6,
             wellPanel(
               style = "background-color: #004953; color: #ffffff;",
               h4("Previous Year-to-Date"),
               h5(textOutput("previousYTD"))
             )
      )
    ),
    div(style = "text-align: right;",
        downloadButton("downloadData", "Download Data"),
        downloadButton("downloadPlot", "Download Plot"))
  )
)

# Shiny Server
server <- function(input, output, session) {
  # Reactive data based on user inputs
  reactiveData <- reactive({
    data %>%
      filter(`Crime Type` %in% input$crimeType,
             `Agency Name` %in% input$agencyName,
             Year %in% input$yearFilter) %>%
      arrange(Month)
  })

  # Generate plot
  output$crimePlot <- renderPlotly({
    df <- reactiveData()
    plot_ly(df, x = ~Month, y = ~Total_Incidents, color = ~`Crime Type`, type = 'scatter', mode = 'lines+markers',
            line = list(color = "#f28106"), selectedpoints = tableRows()) %>%
      layout(
        xaxis = list(tickformat = "%b", 
                     tickfont = list(size = 12, color = "black", family = "Roboto Condensed", face = "bold"), 
                     titlefont = list(size = 14, color = "black", family = "Roboto Condensed", face = "bold"), 
                     zeroline = FALSE,
                     showgrid = FALSE,
                     tick0 = as.numeric(min(df$Month)), 
                     dtick = "M1", 
                     tickangle = -45),
        xaxis2 = list(tickformat = "%Y", 
                      tickfont = list(size = 10, color = "black", family = "Roboto Condensed", face = "bold"), 
                      overlaying = "x", 
                      side = "bottom",
                      tick0 = as.numeric(min(df$Month)), 
                      dtick = "M12",
                      title = "Year"),
        yaxis = list(title = paste("Count of", paste(input$crimeType, collapse = ", ")),
                     tickfont = list(size = 12, color = "black", family = "Roboto Condensed", face = "bold"), 
                     titlefont = list(size = 14, color = "black", family = "Roboto Condensed", face = "bold"), 
                     rangemode = "nonnegative",
                     range = c(0, max(df$Total_Incidents, na.rm = TRUE)))
      )
  })

  # Render the data table
  output$dataTable <- renderDT({
    datatable(reactiveData(), selection = 'single', options = list(
      pageLength = 10,
      scrollX = TRUE,
      initComplete = JS("function(settings, json) {",
                        "$(this.api().table().header()).css({'background-color': '#2d5ef9', 'color': '#ffffff'});",
                        "$('.dataTables_wrapper').find('label').each(function() {",
                        "$(this).css('color', '#ffffff');",
                        "});",
                        "$('.dataTables_wrapper').find('.dataTables_info').css('color', '#ffffff');",
                        "$('.dataTables_wrapper').find('.paginate_button').css('color', '#ffffff');",  # Styles all pagination buttons
                        "$('.dataTables_wrapper').find('table').css('color', '#ffffff');",
                        "$('.paginate_button').not('.current').hover(function() {",
                        "$(this).css('color', '#2d5ef9').css('background-color', '#ffffff');",  # Changes button color on hover
                        "}, function() {",
                        "$(this).css('color', '#ffffff').css('background-color', '');",  # Revert on mouse out
                        "});",
                        "}"),
      dom = 'Bfrtip',
      buttons = list(
        'copy', 'csv', 'excel', 'pdf', 'print'
      )
    ), callback = JS("table.draw();"))
  })

  # Toggle view between plot and data table
  observeEvent(input$toggleView, {
    if (input$toggleView %% 2 == 1) {
      output$viewOutput <- renderUI({
        DTOutput("dataTable")
      })
    } else {
      output$viewOutput <- renderUI({
        plotlyOutput("crimePlot", height = "600px")
      })
    }
  })

  # Set initial view to plot
  output$viewOutput <- renderUI({
    plotlyOutput("crimePlot", height = "600px")
  })

  # Reactive function to get the selected row indices
  tableRows <- reactive({
    input$dataTable_rows_selected
  })

  # Calculate and display YTD crime data
  output$currentYTD <- renderText({
    df <- reactiveData()
    currentYTD <- df %>%
      filter(Year == max(Year)) %>%
      summarize(YTD = sum(Total_Incidents)) %>%
      pull(YTD)
    paste("Total Incidents: ", currentYTD)
  })

  output$previousYTD <- renderText({
    df <- reactiveData()
    previousYTD <- df %>%
      filter(Year == max(Year) - 1) %>%
      summarize(YTD = sum(Total_Incidents)) %>%
      pull(YTD)
    paste("Total Incidents: ", previousYTD)
  })

  # Download handlers
  output$downloadData <- downloadHandler(
    filename = function() {
      paste("Crime-Data-", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(reactiveData(), file)
    }
  )

  output$downloadPlot <- downloadHandler(
    filename = function() {
      paste("Crime-Plot-", Sys.Date(), ".jpeg", sep = "")
    },
    content = function(file) {
      plotly_save(plotly_last(), file)
    }
  )
}

# Run the application
shinyApp(ui = ui, server = server)


```
this works. 6.20.24
```{r}
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(lubridate)
library(DT)  # For rendering interactive data tables
library(RColorBrewer)  # For generating color palettes

# Assuming data is already loaded and transformed
data <- final_data
data$Date <- as.Date(paste0(data$Year, "-", data$Month, "-01"), format = "%Y-%m-%d")
data$Month <- floor_date(data$Date, "month")

# Default selections
default_crime_type <- "Murder"
default_agency <- sort(unique(data$`Agency Name`))[1]
default_years <- unique(data$Year)

# Helper function to format crime type label
format_crime_type_label <- function(crime_types) {
  if (length(crime_types) > 1) {
    paste(crime_types[-length(crime_types)], collapse = ", ", sep = "") %>%
      paste("&", crime_types[length(crime_types)], sep = " ")
  } else {
    crime_types
  }
}

# Function to add shaded background for every other year
add_shaded_background <- function(plot, data) {
  plot + 
    geom_rect(data = data.frame(xmin = as.Date(paste0(unique(data$Year)[c(FALSE, TRUE)], "-01-01")),
                                xmax = as.Date(paste0(unique(data$Year)[c(FALSE, TRUE)], "-12-31")),
                                ymin = -Inf, ymax = Inf),
              aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
              fill = "grey80", alpha = 0.5, inherit.aes = FALSE)
}

# Shiny UI
ui <- fluidPage(
  tags$head(
    tags$style(HTML("
      @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');
      body { 
        font-family: 'Roboto Condensed', sans-serif;
        background-color: #00333a;
        color: #ffffff;  # Ensure text is readable against a dark background
      }
      .shiny-output-error { color: #ffffff; }  # Error message color
      .shiny-output-error:before { content: 'Error: '; }
      .sidebar { background-color: #2d5ef9; }  # Change sidebar background color
      .main-panel { width: 100%; }
      .well { padding: 10px; }  # Reduce the padding in wellPanel for KPI boxes
      h2.title { text-align: center; font-size: 30px; font-family: 'Roboto Condensed', sans-serif; }
    "))
  ),
  div(style = "width: 100%; text-align: center; margin-top: 20px;",  # Center the title within the container
    h2(class = "title", "Real-Time Crime Index")
  ),
  div(style = "width: 100%;",  # Ensure the top panel matches the plot width
    fluidRow(
      column(12, div(style = "padding-top: 20px; font-size: 20px;",
        span("I want to see "),
        div(style = "display: inline-block; width: 20%; position: relative;", 
             selectInput("crimeType", "", choices = unique(data$`Crime Type`), multiple = TRUE, selected = default_crime_type, width = '100%'),
             div(style = "border-bottom: 1px solid #ffffff; width: 100%;")
        ),
        span(" for "),
        div(style = "display: inline-block; width: 20%; position: relative;", 
             selectInput("agencyName", "", choices = unique(data$`Agency Name`), selected = default_agency, width = '100%'),
             div(style = "border-bottom: 1px solid #ffffff; width: 100%;")
        ),
        span(" from "),
        div(style = "display: inline-block; width: 20%; position: relative;", 
             selectInput("yearFilter", "", choices = unique(data$Year), multiple = TRUE, selected = default_years, width = '100%'),
             div(style = "border-bottom: 1px solid #ffffff; width: 100%;")
        )
      ))
    ),
    fluidRow(
      column(12, div(style = "padding-top: 10px; text-align: left;",
        actionButton("toggleView", "View Table", class = "btn-primary")
      ))
    )
  ),
  mainPanel(
    class = "main-panel",
    uiOutput("viewOutput"),
    fluidRow(
      column(4,
             wellPanel(
               style = "background-color: #004953; color: #ffffff;",
               h4("Current Year-to-Date"),
               h5(textOutput("currentYTD"))
             )
      ),
      column(4,
             wellPanel(
               style = "background-color: #004953; color: #ffffff;",
               h4("Previous Year-to-Date"),
               h5(textOutput("previousYTD"))
             )
      ),
      column(4,
             wellPanel(
               style = "background-color: #004953; color: #ffffff;",
               h4("Percent Change YTD"),
               h5(textOutput("percentChangeYTD"))
             )
      )
    ),
    div(style = "text-align: right;",
        downloadButton("downloadData", "Download Table"),
        downloadButton("downloadPlot", "Download Graph"))
  )
)

# Shiny Server
server <- function(input, output, session) {
  # Reactive data based on user inputs
  reactiveData <- reactive({
    data %>%
      filter(`Crime Type` %in% input$crimeType,
             `Agency Name` %in% input$agencyName,
             Year %in% input$yearFilter) %>%
      arrange(Month)
  })

  # Generate plot
  output$crimePlot <- renderPlotly({
    df <- reactiveData()
    colors <- brewer.pal(n = length(unique(df$`Crime Type`)), name = "Set1")
    p <- ggplot(df, aes(x = Month, y = Total_Incidents, color = `Crime Type`)) +
      geom_line() +
      geom_point() +
      scale_color_manual(values = colors) +
      scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
      scale_y_continuous(breaks = pretty(df$Total_Incidents), labels = scales::label_number(accuracy = 1)) +
      labs(x = "Year", y = paste("Count of", format_crime_type_label(unique(df$`Crime Type`)))) +
      theme_minimal() +
      theme(
        axis.text.x = element_text(size = 12, face = "bold", family = "Roboto Condensed", hjust = 0.5),
        axis.title.x = element_text(size = 14, face = "bold", family = "Roboto Condensed"),
        axis.title.y = element_text(size = 14, face = "bold", family = "Roboto Condensed"),
        legend.position = "none"  # Remove legend
      )
    
    # Add shaded background for every other year
    p <- add_shaded_background(p, df)
    
    ggplotly(p)
  })

  # Render the data table
  output$dataTable <- renderDT({
    datatable(reactiveData(), selection = 'single', options = list(
      pageLength = 10,
      scrollX = TRUE,
      initComplete = JS("function(settings, json) {",
                        "$(this.api().table().header()).css({'background-color': '#2d5ef9', 'color': '#ffffff'});",
                        "$('.dataTables_wrapper').find('label').each(function() {",
                        "$(this).css('color', '#ffffff');",
                        "});",
                        "$('.dataTables_wrapper').find('.dataTables_info').css('color', '#ffffff');",
                        "$('.dataTables_wrapper').find('.paginate_button').css('color', '#ffffff');",  # Styles all pagination buttons
                        "$('.dataTables_wrapper').find('table').css('color', '#ffffff');",
                        "$('.paginate_button').not('.current').hover(function() {",
                        "$(this).css('color', '#2d5ef9').css('background-color', '#ffffff');",  # Changes button color on hover
                        "}, function() {",
                        "$(this).css('color', '#ffffff').css('background-color', '');",  # Revert on mouse out
                        "});",
                        "}"),
      dom = 'Bfrtip',
      buttons = list(
        'copy', 'csv', 'excel', 'pdf', 'print'
      )
    ), callback = JS("table.draw();"))
  })

  # Toggle view between plot and data table
  observeEvent(input$toggleView, {
    if (input$toggleView %% 2 == 1) {
      updateActionButton(session, "toggleView", label = "View Graph")
      output$viewOutput <- renderUI({
        DTOutput("dataTable")
      })
    } else {
      updateActionButton(session, "toggleView", label = "View Table")
      output$viewOutput <- renderUI({
        plotlyOutput("crimePlot", height = "600px")
      })
    }
  })

  # Set initial view to plot
  output$viewOutput <- renderUI({
    plotlyOutput("crimePlot", height = "600px")
  })

  # Reactive function to get the selected row indices
  tableRows <- reactive({
    input$dataTable_rows_selected
  })

  # Calculate and display YTD crime data
  output$currentYTD <- renderText({
    df <- reactiveData()
    currentYTD <- df %>%
      filter(Year == max(Year)) %>%
      group_by(`Crime Type`) %>%
      summarize(YTD = sum(Total_Incidents)) %>%
      pull(YTD)
    paste("Total Incidents: ", currentYTD)
  })

  output$previousYTD <- renderText({
    df <- reactiveData()
    previousYTD <- df %>%
      filter(Year == max(Year) - 1) %>%
      group_by(`Crime Type`) %>%
      summarize(YTD = sum(Total_Incidents)) %>%
      pull(YTD)
    paste("Total Incidents: ", previousYTD)
  })

  output$percentChangeYTD <- renderText({
    df <- reactiveData()
    currentYTD <- df %>%
      filter(Year == max(Year)) %>%
      group_by(`Crime Type`) %>%
      summarize(YTD = sum(Total_Incidents)) %>%
      pull(YTD)
    previousYTD <- df %>%
      filter(Year == max(Year) - 1) %>%
      group_by(`Crime Type`) %>%
      summarize(YTD = sum(Total_Incidents)) %>%
      pull(YTD)
    percentChange <- ((currentYTD - previousYTD) / previousYTD) * 100
    paste("Percent Change: ", round(percentChange, 2), "%")
  })

  # Download handlers
  output$downloadData <- downloadHandler(
    filename = function() {
      paste("Crime-Data-", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(reactiveData(), file)
    }
  )

  output$downloadPlot <- downloadHandler(
    filename = function() {
      paste("Crime-Graph-", Sys.Date(), ".jpeg", sep = "")
    },
    content = function(file) {
      plotly_save(plotly_last(), file)
    }
  )
}

# Run the application
shinyApp(ui = ui, server = server)


```

new experimental
```{r}
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(lubridate)
library(DT)  # For rendering interactive data tables
library(RColorBrewer)  # For generating color palettes

# Assuming data is already loaded and transformed
data <- final_data
data$Date <- as.Date(paste0(data$Year, "-", data$Month, "-01"), format = "%Y-%m-%d")
data$Month <- floor_date(data$Date, "month")

# Default selections
default_crime_type <- "Murder"
default_agency <- sort(unique(data$`Agency Name`))[1]
default_years <- unique(data$Year)

# Helper function to format crime type label
format_crime_type_label <- function(crime_types) {
  if (length(crime_types) > 1) {
    paste(crime_types[-length(crime_types)], collapse = ", ", sep = "") %>%
      paste("&", crime_types[length(crime_types)], sep = " ")
  } else {
    crime_types
  }
}

# Function to add shaded background for every even-numbered year
add_shaded_background <- function(plot, data) {
  even_years <- unique(data$Year[data$Year %% 2 == 0])
  plot + 
    geom_rect(data = data.frame(xmin = as.Date(paste0(even_years, "-01-01")),
                                xmax = as.Date(paste0(even_years, "-12-31")),
                                ymin = -Inf, ymax = Inf),
              aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
              fill = "grey90", alpha = 0.5, inherit.aes = FALSE)
}

# Shiny UI
ui <- fluidPage(
  tags$head(
    tags$style(HTML("
      @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');
      body { 
        font-family: 'Roboto Condensed', sans-serif;
        background-color: #00333a;
        color: #ffffff;  # Ensure text is readable against a dark background
      }
      .shiny-output-error { color: #ffffff; }  # Error message color
      .shiny-output-error:before { content: 'Error: '; }
      .sidebar { background-color: #2d5ef9; }  # Change sidebar background color
      .main-panel { width: 100%; }
      .well { padding: 10px; }  # Reduce the padding in wellPanel for KPI boxes
      h2.title { text-align: center; font-size: 30px; font-family: 'Roboto Condensed', sans-serif; }
    "))
  ),
  div(style = "width: 100%; text-align: center; margin-top: 20px;",  # Center the title within the container
    h2(class = "title", "Real-Time Crime Index")
  ),
  div(style = "width: 100%;",  # Ensure the top panel matches the plot width
    fluidRow(
      column(12, div(style = "padding-top: 20px; font-size: 20px;",
        span("I want to see "),
        div(style = "display: inline-block; width: 20%; position: relative;", 
             selectInput("crimeType", "", choices = unique(data$`Crime Type`), multiple = TRUE, selected = default_crime_type, width = '100%'),
             div(style = "border-bottom: 1px solid #ffffff; width: 100%;")
        ),
        span(" for "),
        div(style = "display: inline-block; width: 20%; position: relative;", 
             selectInput("agencyName", "", choices = unique(data$`Agency Name`), selected = default_agency, width = '100%'),
             div(style = "border-bottom: 1px solid #ffffff; width: 100%;")
        ),
        span(" from "),
        div(style = "display: inline-block; width: 20%; position: relative;", 
             selectInput("yearFilter", "", choices = unique(data$Year), multiple = TRUE, selected = default_years, width = '100%'),
             div(style = "border-bottom: 1px solid #ffffff; width: 100%;")
        )
      ))
    ),
    fluidRow(
      column(12, div(style = "padding-top: 10px; text-align: left;",
        actionButton("toggleView", "View Table", class = "btn-primary")
      ))
    )
  ),
  mainPanel(
    class = "main-panel",
    uiOutput("viewOutput"),
    fluidRow(
      column(4,
             wellPanel(
               style = "background-color: #004953; color: #ffffff;",
               h4("Current Year-to-Date"),
               h5(textOutput("currentYTD")),
               textOutput("currentYTDLabel")
             )
      ),
      column(4,
             wellPanel(
               style = "background-color: #004953; color: #ffffff;",
               h4("Previous Year-to-Date"),
               h5(textOutput("previousYTD")),
               textOutput("previousYTDLabel")
             )
      ),
      column(4,
             wellPanel(
               style = "background-color: #004953; color: #ffffff;",
               h4("Percent Change YTD"),
               h5(textOutput("percentChangeYTD")),
               textOutput("percentChangeYTDLabel")
             )
      )
    ),
    div(style = "text-align: right;",
        downloadButton("downloadData", "Download Table"),
        downloadButton("downloadPlot", "Download Graph"))
  )
)

# Shiny Server
server <- function(input, output, session) {
  # Reactive data based on user inputs
  reactiveData <- reactive({
    data %>%
      filter(`Crime Type` %in% input$crimeType,
             `Agency Name` %in% input$agencyName,
             Year %in% input$yearFilter) %>%
      arrange(Month)
  })

  # Generate plot
  output$crimePlot <- renderPlotly({
    df <- reactiveData()
    colors <- brewer.pal(n = length(unique(df$`Crime Type`)), name = "Set1")
    p <- ggplot(df, aes(x = Month, y = Total_Incidents, color = `Crime Type`)) +
      geom_line() +
      geom_point() +
      scale_color_manual(values = colors) +
      scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
      scale_y_continuous(breaks = pretty(df$Total_Incidents), labels = scales::label_number(accuracy = 1)) +
      labs(x = "Year", y = paste("Count of", format_crime_type_label(unique(df$`Crime Type`)))) +
      theme_minimal() +
      theme(
        axis.text.x = element_text(size = 12, face = "bold", family = "Roboto Condensed", hjust = 0.5),
        axis.title.x = element_text(size = 14, face = "bold", family = "Roboto Condensed"),
        axis.title.y = element_text(size = 14, face = "bold", family = "Roboto Condensed"),
        legend.position = "none"  # Remove legend
      )
    
    # Add shaded background for every even-numbered year
    p <- add_shaded_background(p, df)
    
    ggplotly(p)
  })

  # Render the data table
  output$dataTable <- renderDT({
    datatable(reactiveData(), selection = 'single', options = list(
      pageLength = 10,
      scrollX = TRUE,
      initComplete = JS("function(settings, json) {",
                        "$(this.api().table().header()).css({'background-color': '#2d5ef9', 'color': '#ffffff'});",
                        "$('.dataTables_wrapper').find('label').each(function() {",
                        "$(this).css('color', '#ffffff');",
                        "});",
                        "$('.dataTables_wrapper').find('.dataTables_info').css('color', '#ffffff');",
                        "$('.dataTables_wrapper').find('.paginate_button').css('color', '#ffffff');",  # Styles all pagination buttons
                        "$('.dataTables_wrapper').find('table').css('color', '#ffffff');",
                        "$('.paginate_button').not('.current').hover(function() {",
                        "$(this).css('color', '#2d5ef9').css('background-color', '#ffffff');",  # Changes button color on hover
                        "}, function() {",
                        "$(this).css('color', '#ffffff').css('background-color', '');",  # Revert on mouse out
                        "});",
                        "}"),
      dom = 'Bfrtip',
      buttons = list(
        'copy', 'csv', 'excel', 'pdf', 'print'
      )
    ), callback = JS("table.draw();"))
  })

  # Toggle view between plot and data table
  observeEvent(input$toggleView, {
    if (input$toggleView %% 2 == 1) {
      updateActionButton(session, "toggleView", label = "View Graph")
      output$viewOutput <- renderUI({
        DTOutput("dataTable")
      })
    } else {
      updateActionButton(session, "toggleView", label = "View Table")
      output$viewOutput <- renderUI({
        plotlyOutput("crimePlot", height = "600px")
      })
    }
  })

  # Set initial view to plot
  output$viewOutput <- renderUI({
    plotlyOutput("crimePlot", height = "600px")
  })

  # Reactive function to get the selected row indices
  tableRows <- reactive({
    input$dataTable_rows_selected
  })

  # Calculate and display YTD crime data
  output$currentYTD <- renderText({
    df <- reactiveData()
    currentYTD <- df %>%
      filter(Year == max(Year)) %>%
      group_by(`Crime Type`) %>%
      summarize(YTD = sum(Total_Incidents)) %>%
      pull(YTD)
    paste("Total Incidents: ", currentYTD)
  })

  output$currentYTDLabel <- renderText({
    paste("Crime Type: ", format_crime_type_label(input$crimeType))
  })

  output$previousYTD <- renderText({
    df <- reactiveData()
    previousYTD <- df %>%
      filter(Year == max(Year) - 1) %>%
      group_by(`Crime Type`) %>%
      summarize(YTD = sum(Total_Incidents)) %>%
      pull(YTD)
    paste("Total Incidents: ", previousYTD)
  })

  output$previousYTDLabel <- renderText({
    paste("Crime Type: ", format_crime_type_label(input$crimeType))
  })

  output$percentChangeYTD <- renderText({
    df <- reactiveData()
    currentYTD <- df %>%
      filter(Year == max(Year)) %>%
      group_by(`Crime Type`) %>%
      summarize(YTD = sum(Total_Incidents)) %>%
      pull(YTD)
    previousYTD <- df %>%
      filter(Year == max(Year) - 1) %>%
      group_by(`Crime Type`) %>%
      summarize(YTD = sum(Total_Incidents)) %>%
      pull(YTD)
    percentChange <- ((currentYTD - previousYTD) / previousYTD) * 100
    paste("Percent Change: ", round(percentChange, 2), "%")
  })

  output$percentChangeYTDLabel <- renderText({
    paste("Crime Type: ", format_crime_type_label(input$crimeType))
  })

  # Download handlers
  output$downloadData <- downloadHandler(
    filename = function() {
      paste("Crime-Data-", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(reactiveData(), file)
    }
  )

  output$downloadPlot <- downloadHandler(
    filename = function() {
      paste("Crime-Graph-", Sys.Date(), ".jpeg", sep = "")
    },
    content = function(file) {
      plotly_save(plotly_last(), file)
    }
  )
}

# Run the application
shinyApp(ui = ui, server = server)

```




