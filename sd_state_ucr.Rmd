---
title: "south dakota ucr processing"
output: pdf_document
date: "2024-04-18"
---
```{r}
#install.packages("lubridate")
library(lubridate)
library(tidyverse)
library(stringr)
```
yearly, incident level files
```{r}
setwd("C:\\OneDrive\\OneDrive - ahdatalytics.com\\Clients\\Real Time Crime Index\\Open Source Data\\South Dakota\\State UCR")

df <- read.csv("2022_SD_NIBRSPartOneRaw.csv")
```
what does the top look like
```{r}
head(df)
```

create separate month and year categories
```{r}
# Convert date string to Date object
df$date_obj <- mdy(df$Incident.Date)

# Extract month and year
df$month <- month(df$date_obj)
df$year <- year(df$date_obj)
df
```
create a new table that aggregates by agency + month + year + UCR.Offense.Code
```{r}
# Aggregate records based on four columns and create a new table with counts
aggregated_counts <- df %>%
  group_by(Agency.Name, UCR.Offense.Code, month, year) %>%
  summarise(count = n())
```
what are the unique values in the UCR code column?
```{r}
table(df$UCR.Offense.Code)
```
let's get the crimes as columns
```{r}
values <- c("count")
# Create series of columns based on the values of the 'Category' column
df_wide <- aggregated_counts %>%
  pivot_wider(names_from = UCR.Offense.Code, values_from = values)

# Print the resulting dataframe
print(df_wide)
```
remove records with NA in the year column
```{r}
clean_data <- df_wide %>%
  filter(!is.na(year))
```
convert columns to numeric and fill in NA's with 0
```{r}
clean_data1 <- clean_data %>%
  mutate(across(.cols = -1, ~ as.numeric(replace(., is.na(.), 0))))

```
sum column values to get SRS figures from NIBRS
From NIBRS OFFENSE CODES MANUAL 2011
```{r}
#murder 09A - Murder & Nonnegligent Manslaughter

#rape - 11A - Forcible Rape

#agg assault - 13A - Aggravated Assault

#robbery - 120 - Robbery

#burglary - 220 - Burglary/Breaking & Entering

#Larceny/Theft Offenses to sum
#Pocket-picking Property,  Purse-snatching Property,  Shoplifting Property,  Theft From Building Property,  Theft From Coin-Operated Machine or Device Property,  Theft From Motor Vehicle Property,  Theft of Motor Vehicle Parts or Accessories Property,All Other Larceny Property

columns_to_larc <- c("Pocket-picking",	"Purse-snatching",	"Shoplifting",	"Theft From Building",	"Theft From Coin-Operated Machine or Device",	"Theft From Motor Vehicle",	"Theft From Motor Vehicle Parts/Accessories",	"All Other Larceny")

clean_data1$Larceny <- rowSums(clean_data1[columns_to_larc])

#mvt - 240 - Motor Vehicle Theft

#arson -200 - Arson
```
drop unnecessary columns
```{r}
#we need...
columns_to_keep <- c("Agency.Name", 
                 "Murder and Nonnegligent Manslaughter",
                 "Rape", "Robbery", "Aggravated Assault", 
                 "Burglary/Breaking and Entering",
                 "Larceny", "Motor Vehicle Theft",
                 "Arson" )

# Function to keep specified columns from a dataframe
data_clean2 <- subset(clean_data1, select = columns_to_keep)
```
rename each column for all dataframes in list
```{r}
#list of column names
final_col_names <-  c("Agency Name","Murder",	"Rape",	"Robbery",
"Agg Assault",	"Burglary",	"Larceny",	"MVT",	"Arson")

#apply column names
names(data_clean2)<- final_col_names

head(data_clean2)
```
add a column the designates the time period
```{r}
list_of_dataframes <- ldf4

# Function to add a column with the name of the data frame
add_column_with_dataframe_name <- function(df) {
  df$name_column <- names(list_of_dataframes)[match(deparse(substitute(df)), names(list_of_dataframes))]
  df
}

# Apply the function to each data frame in the list
list_of_dataframes_with_column <- lapply(names(list_of_dataframes), function(df_name) {
  df <- list_of_dataframes[[df_name]]
  df$name_column <- df_name
  df
})
ldf5 <- list_of_dataframes_with_column
```
drop last two rows (empty cell followed by automated text cell)
```{r}
row_index_to_remove <- c(20,21)  # Remove the third row

# Function to remove row based on index number
remove_row_by_index <- function(df) {
  df_trimmed <- df[-row_index_to_remove, ]
  return(df_trimmed)
}

# Apply the function to each dataframe in the list
ldf6 <- lapply(ldf5, remove_row_by_index)

```



row bind the list together
```{r}
combined_df <- do.call(rbind, list_of_dataframes_with_column)

```
write it out!
```{r}
write.csv(phx_table_subset, "az_state_ucr_2022.csv")


```




#notes
#Online version
#pdftools::pdf_text(pdf = "http://arxiv.org/pdf/1403.2805.pdf")
