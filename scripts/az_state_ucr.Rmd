---
title: "arizona state ucr"
output: pdf_document
date: "2024-04-16"
updated: "2024-06-10"
updated: "2024-07-23"
---
```{r}
library(tidyverse)
library(stringr)
```
directory path where the arizona files are stored
```{r}
data_dir <- "C:\\OneDrive\\OneDrive - ahdatalytics.com\\Clients\\Real Time Crime Index\\Open Source Data\\Arizona\\State UCR"
```
read everything in, extract the month/year and do the initial processing
```{r}
# List all CSV files in the directory
file_paths <- list.files(data_dir, pattern = "\\.csv$", full.names = TRUE)

# Debug: Check if any files are listed
if (length(file_paths) == 0) {
  stop("No CSV files found in the specified directory.")
} else {
  message("Processing ", length(file_paths), " files.")
}

# Function to read a CSV and extract date parts
process_csv <- function(file_path) {
  # Debug: Check the file path
  message("Reading file: ", file_path)
  
  # Attempt to read the CSV file
  tryCatch({
    df <- read_csv(file_path, show_col_types = FALSE)
  }, error = function(e) {
    warning("Failed to read: ", file_path, " Error: ", e$message)
    return(NULL)  # Return NULL if the file cannot be read
  })

  # Extract the first 7 characters from the filename (assumes 'YYYY-MM' format)
  filename <- basename(file_path)
  date_part <- substr(filename, 1, 7)

  # Parse year and month from the date_part
  year <- as.integer(substr(date_part, 1, 4))
  month <- as.integer(substr(date_part, 6, 7))

  # Add year and month as columns
  if (!is.na(year) && !is.na(month)) {
    df <- df %>%
      mutate(Year = year, Month = month)
  } else {
    warning("Date parsing failed for: ", filename)
  }

  return(df)
}

# Apply the function to each file path and store dataframes in a list
ldf <- setNames(lapply(file_paths, process_csv), basename(file_paths))
```
check it out
```{r}
head(ldf[1])
```
drop the first 5 rows
```{r}
ldf1 <- lapply(ldf, tail, -6)
```
rename each column for all dataframes in list
```{r}
#list of column names
col_names <-  c("Agency Name","Murder",	"Rape",	"Robbery",
"Agg Assault",	"Burglary",	"Larceny",	"MVT",	"Arson", "Year", "Month")

#apply column names
ldf1 <- lapply(ldf1, setNames, col_names)

head(ldf1[1])
```
fill in empty cells with 0
```{r}
#simple function to apply to all dataframes in list
replace_empty_with_zero <- function(df) {
  df[df == ""] <- "0"
  df
}

# Apply the function to each data frame in the list
ldf2 <- lapply(ldf1, replace_empty_with_zero)

# Print the modified list of data frames
head(ldf2[1])
```
change NA to 0 and make sure that we don't have NA values in the time variables
```{r}
# Function to clean the data frame
clean_df <- function(df) {
  # Filter out rows where 'Year' and 'Month' columns have NA values
  clean_data <- df %>%
    filter(!is.na(Year) & !is.na(Month))
  
  # Convert all columns (except the first one) to numeric and replace NA with 0
  clean_data1 <- clean_data %>%
    mutate(across(.cols = -1, ~ as.numeric(replace(., is.na(.), 0))))
  
  return(clean_data1)
}

# Apply function to data frames in list
ldf3 <- lapply(ldf2, clean_df)

#take a look
head(ldf3[1])
```
combine everything
```{r}
combined_df <- do.call(rbind, ldf3)
```
reorder columns and done
```{r}
# Specified order for the columns
column_order <- c("Agency Name", "Murder", "Rape", "Robbery", 
                  "Agg Assault", "Burglary", "Larceny", "MVT", "Arson",
                   "Month", "Year")

# Reorder columns based on the specified order
final_df <- combined_df[, column_order]
```
add a column for State and then we're done.
```{r}
# Specify the value for the "State" column
state_value <- "Arizona"

# Add the "State" column to the data frame
final_df$State <- state_value
```
write it out!
```{r}
# Specify the folder path
folder_path <- "C:\\OneDrive\\OneDrive - ahdatalytics.com\\Clients\\Real Time Crime Index\\Open Source Data\\Arizona\\Formatted Data"

# Create the full file path
file_path <- file.path(folder_path, "az_jan22_present.csv")

# Write the data frame to a .csv file
write.csv(final_df, file = file_path, row.names = FALSE)
```

